---
title: games101课程笔记13-Ray Tracing
tags: 
  - Notes
  - Computer graphics
categories: 
  - [Games, Games101]
date: 2024-12-05 20:20:00
math: true

---

光追，启动！

<!-- more -->

**开始之前**：为什么要使用光线追踪？

因为光栅化（rasterization）不能很好地解决全局光照里的一系列问题：

- 软阴影
- 光线弹射不止一次时的情况
  - 磨砂质感（glossy reflection）物体上的环境映射
  - 间接光照计算

## Whitted-Style Ray Tracing

**前置**：对光线的设定

- 光沿直线传播，并且本身就是直线
- 光线没有碰撞现象（即使两条光线交叉时）
- 光线具有可逆性（光路是可逆的）

#### 光线渲染

因为光路是可逆的，所以这里假设光线是由眼睛发出的，并由光源接收（**这里假设眼睛和光源都是一个点**）

视线（**视点**出发经过**成像平面的一个像素点**的射线）可以分为两个部分：`primary ray`和`secondary rays`（包含所有经过反射和折射的线路）。

在视线和物体相交后，将交点和光源连线（这条线称为`shadow rays`）如果这条线段没有被遮挡，则可以认为这一部分是可以照亮的。

然后将所有的颜色叠加起来可以算出这个像素点的颜色。

<img src="https://pic-poivre.oss-cn-hangzhou.aliyuncs.com/pics/7f90fa96a9059521a7cc34d0a3fb45b.jpg" alt="7f90fa96a9059521a7cc34d0a3fb45b" style="width:70%;" />

#### 如何计算射线和表面的交点

射线由**原点（origin）**和方向组成，可以表示为：
$$
r(t)=o+td(0≤t<+∞)
$$
其中，t表示时刻。

##### 光线和隐式表面的交点

隐式表面上的点满足：
$$
P：f(P)=0
$$
联立射线方程，可以解得交点：
$$
f(o+td)=0
$$
你将得到，所有满足**实根**、**正根**要求的就是要求的交点。

#### 如何计算射线和网格的交点

一个规律：从平面上的点为原点射出一条射线，如果点在网格内，那么这条射线和网格的交点为奇数个；如果点在网格外，那么这条射线和网格的交点则为偶数个。

简化这个问题：

- 忽略光线和平面平行的情况，此时光线和平面的交点只有0和1两种。

##### 计算射线和三角形的交点

**方法一**

分为两步：

- 求光线和平面的交点
- 判断这个交点是否在三角形内

 平面可以由一个`法向量N`和`平面上的一个点P'`表示，平面上的点P可以表示为：
$$
P:(p-p')·N=0
$$
和之前一样，联立射线方程，可以解得`相交时间t`。
$$
t=\frac{(p'-o)·N}{d·N}(0≤t<+∞)
$$
**方法二** Möller Trumbore Algorithm（MT算法）

另外，还有一种一步到位的方法。射线和平面的交点可以表示为重心坐标的形式，联立可得：
$$
o+td=(1-b_1-b_2)P_o+b_1P_1+b_2P_2(b_1,b_2,1-b_1-b_2,t≥0)
$$
代入三角形顶点的三个维度的坐标，可以获得一个线性方程组（可以使用克拉默法则解出），得到`t`,`b1`,`b2`。

##### 方法三（求交加速方法，使用包围盒（Bounding Volumes））

用简单的形状将物体框起来，在光线和三角面片求交前先确保光线能够碰到包围盒。

包围盒是由三组对面（slab）形成的交集

常使用**Axis-Aligned Bounding Box(AABB)**这种包围盒，这个包围盒的几个平面与坐标轴平面是**平行**的。这时，求解射线和平面的交线时只需考虑单个维度的计算即可（因为平面总是和轴平面是平行的），大大减少了计算量。

如何求光线和包围盒的交点呢？

1. 求出光线和三组对面的交点，记录射线和对面交点的进入点和离开点。

2. 然后取这三组交点的交集，满足：
   $$
   t_{enter}=max(t_{min}),t_{exit}=min(t_{max})
   $$

3. 当且仅当满足这个要求时，认为光线是和包围盒相交的：
   $$
   t_{enter}<t_{exit},t_{exit}≥0
   $$
   
